<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Edu2Job Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 text-white">
  <div class="container mx-auto py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">ðŸš€ Edu2Job Dashboard</h1>
      <a href="/logout" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg">Logout</a>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-4 mb-6">
      <button type="button" onclick="showTab('profile')" class="tab-btn bg-white/30 px-4 py-2 rounded-lg">Profile</button>
      <button type="button" onclick="showTab('predict')" class="tab-btn bg-white/30 px-4 py-2 rounded-lg">New Prediction</button>
      <button type="button" onclick="showTab('history')" class="tab-btn bg-white/30 px-4 py-2 rounded-lg">History</button>
    </div>

    <!-- Profile Tab -->
    <div id="profile" class="tab-content">
      <h2 class="text-xl font-bold mb-4">Profile Information</h2>
      <form id="profileForm" class="space-y-3 bg-white/20 p-6 rounded-xl">
  <input name="name" placeholder="Full Name" required class="w-full px-3 py-2 rounded-lg text-black"/>
  <input name="email" type="email" placeholder="Gmail" required class="w-full px-3 py-2 rounded-lg text-black"/>
  <input name="college" placeholder="College Name" required class="w-full px-3 py-2 rounded-lg text-black"/>
  <input name="degree" placeholder="Degree" required class="w-full px-3 py-2 rounded-lg text-black"/>
  <input name="major" placeholder="Major" required class="w-full px-3 py-2 rounded-lg text-black"/>
  <input name="cgpa" type="number" step="0.01" placeholder="CGPA" required class="w-full px-3 py-2 rounded-lg text-black"/>
  <input name="experience" type="number" placeholder="Years of Experience" class="w-full px-3 py-2 rounded-lg text-black"/>
  <input name="skills" placeholder="Skills (comma-separated)" class="w-full px-3 py-2 rounded-lg text-black"/>
  <input name="passout_year" type="number" placeholder="Passout Year" class="w-full px-3 py-2 rounded-lg text-black"/>
  <button type="submit" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg w-full">Save Profile</button>
</form>

      <div id="profileMsg" class="mt-2"></div>
    </div>

    <!-- Prediction Tab -->
    <div id="predict" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-4">Make a Prediction</h2>
      <form id="predictForm" class="space-y-3 bg-white/20 p-6 rounded-xl">
        <input name="degree" placeholder="Degree" required class="w-full px-3 py-2 rounded-lg text-black"/>
        <input name="major" placeholder="Major" required class="w-full px-3 py-2 rounded-lg text-black"/>
        <input name="cgpa" type="number" step="0.01" placeholder="CGPA" required class="w-full px-3 py-2 rounded-lg text-black"/>
        <input name="employed" placeholder="Employed (Yes/No)" class="w-full px-3 py-2 rounded-lg text-black"/>
        <input name="experience" type="number" placeholder="Years of Experience" class="w-full px-3 py-2 rounded-lg text-black"/>
        <input name="skills" placeholder="Skills (comma-separated)" class="w-full px-3 py-2 rounded-lg text-black"/>
        <input name="certifications" placeholder="Certifications (comma-separated)" class="w-full px-3 py-2 rounded-lg text-black"/>
        <input name="industry_preference" placeholder="Industry Preference" class="w-full px-3 py-2 rounded-lg text-black"/>
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg w-full">Predict Job Role</button>
      </form>
      <div id="predictionResult" class="mt-3 font-bold"></div>
      <div id="topSuggestions" class="mt-3 font-medium"></div>
    </div>

    <!-- History Tab -->
    <div id="history" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-4">Prediction History</h2>
      <div class="overflow-x-auto max-h-96 rounded-xl">
        <table class="w-full text-left bg-white/20 rounded-xl overflow-hidden">
          <thead class="bg-white/30">
            <tr>
              <th class="px-4 py-2">Date</th>
              <th class="px-4 py-2">Degree</th>
              <th class="px-4 py-2">Major</th>
              <th class="px-4 py-2">CGPA</th>
              <th class="px-4 py-2">Experience</th>
              <th class="px-4 py-2">Skills</th>
              <th class="px-4 py-2">Predicted Role</th>
            </tr>
          </thead>
          <tbody id="historyTable"></tbody>
        </table>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <div class="chart-container w-full h-64">
          <canvas id="roleChart"></canvas>
        </div>
        <div class="chart-container w-full h-64">
          <canvas id="skillChart"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
// -------- Tab Navigation --------
function showTab(id){
  document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

// -------- Form References --------
const profileForm = document.getElementById("profileForm");
const predictForm = document.getElementById("predictForm");
const profileMsg = document.getElementById("profileMsg");
const predictionDiv = document.getElementById("predictionResult");
const topDiv = document.getElementById("topSuggestions");

// -------- Profile --------
async function loadProfile(){
  try {
    const res = await fetch("/api/profile");
    if(res.ok){
      const data = await res.json();
      for(let key in data){
        if(profileForm.elements[key]) profileForm.elements[key].value = data[key] || "";
      }
    }
  } catch(err){
    console.error("Profile load error:", err);
  }
}

profileForm.addEventListener("submit", async e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(profileForm).entries());
  try {
    const res = await fetch("/api/profile", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data)
    });
    profileMsg.textContent = res.ok ? "âœ… Saved" : "âŒ Failed";
  } catch(err){
    profileMsg.textContent = "âŒ Error saving profile";
    console.error(err);
  }
});

// -------- Prediction --------
predictForm.addEventListener("submit", async e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(predictForm).entries());

  try {
    const res = await fetch("/api/predict", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if(res.ok){
      predictionDiv.textContent = `Predicted Job Role: ${result.prediction} (Confidence: ${result.confidence.toFixed(2)}%)`;

      if (result.top_suggestions) {
        let html = `
          <h3 class="text-lg font-semibold mt-4 mb-2 text-white">Top 3 Job Role Suggestions</h3>
          <div class="bg-white/20 rounded-xl p-4 space-y-3">
            ${result.top_suggestions.map(r => `
              <div class="bg-white/30 rounded-lg p-3">
                <p class="text-xl font-bold text-yellow-300">${r.role}</p>
                <p class="text-sm text-white">Confidence Score: <span class="font-semibold">${r.confidence.toFixed(2)}%</span></p>
                <p class="text-sm italic text-gray-200 mt-1">${r.reason}</p>
              </div>
            `).join("")}
          </div>
        `;
        topDiv.innerHTML = html;
      } else {
        topDiv.textContent = "";
      }


      loadHistory();
    } else {
      predictionDiv.textContent = `âŒ Error: ${result.error}`;
      topDiv.textContent = "";
    }
  } catch(err){
    predictionDiv.textContent = "âŒ Network or server error";
    console.error(err);
  }
});

// -------- History & Charts --------
let roleChart, skillChart;
async function loadHistory(){
  try {
    const res = await fetch("/api/history");
    if(!res.ok) return;
    const rows = await res.json();
    const table = document.getElementById("historyTable");

    table.innerHTML = rows.map((r, i) => `
      <tr class="${i % 2 === 0 ? 'bg-white/10' : 'bg-white/20'}">
        <td class="px-4 py-2">${r.created_at || ""}</td>
        <td class="px-4 py-2">${r.degree || ""}</td>
        <td class="px-4 py-2">${r.major || ""}</td>
        <td class="px-4 py-2">${r.cgpa || ""}</td>
        <td class="px-4 py-2">${r.experience || ""}</td>
        <td class="px-4 py-2">${r.skills || ""}</td>
        <td class="px-4 py-2 font-bold">${r.predicted_role || ""}</td>
      </tr>
    `).join("");

    if(roleChart) roleChart.destroy();
    if(skillChart) skillChart.destroy();

    // Roles Bar Chart
    const roleCount = {};
    rows.forEach(r => { if(r.predicted_role) roleCount[r.predicted_role] = (roleCount[r.predicted_role]||0)+1; });
    roleChart = new Chart(document.getElementById("roleChart"), {
      type: "bar",
      data: { labels: Object.keys(roleCount), datasets: [{ label: "Roles", data: Object.values(roleCount), backgroundColor: Object.keys(roleCount).map(() => `hsl(${Math.random()*360},70%,50%)`) }] },
      options: { responsive:true, maintainAspectRatio:false }
    });

    // Skills Doughnut Chart
    const skills = {};
    rows.forEach(r => { if(r.skills) r.skills.split(",").forEach(s => { s=s.trim().toLowerCase(); if(s) skills[s]=(skills[s]||0)+1; }); });
    skillChart = new Chart(document.getElementById("skillChart"), {
      type:"doughnut",
      data: { labels:Object.keys(skills), datasets:[{ data:Object.values(skills), backgroundColor:Object.keys(skills).map(() => `hsl(${Math.random()*360},70%,50%)`) }] },
      options: { responsive:true, maintainAspectRatio:false }
    });

  } catch(err){
    console.error("History load error:", err);
  }
}

// -------- Event Listeners --------
document.querySelector("[onclick=\"showTab('profile')\"]").addEventListener("click", loadProfile);
document.querySelector("[onclick=\"showTab('history')\"]").addEventListener("click", loadHistory);

// Load profile by default
loadProfile();
</script>

</body>
</html>